# Учебный репозиторий курса PurpleSchool NestJS
https://purpleschool.ru/

## Задача
Создать сервис бронирования жилья, простой аналог airbnb

Предметные области сервиса:
- объекты бронирования: могут быть жильем целиком или отдельной комнатой, имеют стоимость за ночь и список удобств. 
- бронирование: создается пользователем для объекта бронирования на определенный период (единица периода - одни целые сутки). Может быть отменено пользователем или администратором.
- пользователи: могут 
  - создавать новые объекты бронирования;
  - редактировать и удалять свои объекты бронирования;
  - создавать и отменять бронирование объектов бронирования.

## Реализация
Сервис построен с использованием фреймворка NestJS и СУБД MongoDB. 

Реализовано REST API для ресурсов:
- users
- rooms
- reservations

Аутентификация пользователей:
- пары логин/пароль;
- с использованием JWT

Авторизация пользователей: 
- с использованием ролей 
- с использованием разрешений на операции с ресурсами на основе аттрибутов объектов (ABAC).

Уведомления
- через телеграм-бота
- через E-Mail

## Запуск приложения
- `docker-compose up -d` - для запуска контейнеров с необходимыми сервисами (mongodb)
- `npm ci` - установка зависимостей
- `npm start` - запуск приложения
- `npm t` - запуск unit-тестов
- `npm run test:e2e` - запуск end-to-end тестов

Настройки приложения берутся из файла `.{NODE_ENV}.env`, а в случае отсутствия - из `.env`

## OpenAPI (Swagger)
Документация в формате OpenAPI доступна по адресам:
- /swagger
- /swagger-json
- /swagger-yaml

## Github Actions
В проекте настроено несколько сценариев автоматической проверки и деплоя приложения (.github/workflows):
- `pull-request` - при создании ПР запускаются модульные и интеграционные тесты. Тесты пропускаются если ПР создается из веток `doc/*` или `ci/*`
- `release` - при пуше в ветку develop создается новый релиз приложения.
- `create-docker-image` - при пуше тэга с меткой версии `v*.*.*` создается образ докера и запускается сценарий деплоя на удаленный сервер (для целей тестирования)

## Создание нового релиза
Новый релиз создается автоматически при мерже пулл-реквеста в ветку `develop`. Для управления релизами используется [release-it](https://github.com/release-it/release-it).
При создании релиза выполняются действия:
- вычисляется новый номер версии, обновляется package.json, изменения пушатся в `develop`;
- создается и пушится в репозиторий новый тег с номером версии;
- создается новый релиз гитхабе с новым тегом версии.

Слияние изменений с веткой `main` выполняется в ручном режиме.

## Деплой
После создания нового тега с номером версии запускается процесс деплоя:
- создается docker-образ в репозитории `ghcr.io`. Образ имеет метки `latest`, `develop` и метки с номером версии.
- создается запрос к API [Drone](https://www.drone.io/) на сервере разработки. В пайплайне выполнятся загрузка созданного образа и запуск контейнера.

После успешного выполнения сценария деплоя приложение доступно на тестовом стенде по адресу http://airbnb3.stage.urup.ru:8000/swagger

## Благодарности и вдохновение
- [Purple School](https://purpleschool.ru/) в лице автора курса [Антона Ларичева](https://github.com/AlariCode) и ментора [Дмитрия Петрова](https://github.com/Dokril)
- https://github.com/rubiin/ultimate-nest - замечательный boilerplate, из которого я использовал множество идей
- https://github.com/getjerry/nest-casl - модуль для интеграции NestJS и библиотеки авторизации [CASL](https://casl.js.org/v5/en/guide/intro)
